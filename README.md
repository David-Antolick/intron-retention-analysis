# Intronâ€‘Retention Analysis Pipeline

**Downstream processing, annotation, and visualisation of IRFinder results â€” built during my time in the RobinÂ Lee Lab (University of Pittsburgh).**

> *This code **does not** run IRFinder itself.* It assumes that IRFinder has already produced perâ€‘sample IR ratio spreadsheets. The pipeline ingests the Excel workbook provided by our lab manager (U2OS cells Â±Â TNFâ€‘Î±), cleans and merges the sheets, enriches events with Ensembl information, translates retained introns, and outputs publicationâ€‘ready summary tables and plots.

---

## Why this exists

* **Automate QC & filtering** across dozens of samples / timeâ€‘points.
* **Map events â†’ gene context** via the Ensembl REST API.
* **Predict coding consequences** â€” is an intron inâ€‘frame, frameâ€‘shifting, or introducing a premature stop?
* **Produce reproducible figures** for lab meetings and manuscripts.

---

## Directory layout

```text
intron-retention-analysis/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ pickler.py              # Excel â†’ .pkl conversion (faster reloads)
â”‚   â”œâ”€â”€ process_ir_data.py      # IR ratio filtering, Î”IR computation
â”‚   â”œâ”€â”€ ensembl_lookup.py       # Fetch sequences / exon coords from Ensembl
â”‚   â”œâ”€â”€ process_sequences.py    # Reconstruct & translate intronâ€‘retained mRNA
â”‚   â”œâ”€â”€ analyze_coding_impact.py# Frame, stopâ€‘codon, NMD classification
â”‚   â”œâ”€â”€ plot_qc_metrics.py      # Perâ€‘replicate QC plots
â”‚   â”œâ”€â”€ plot_intron_types.py    # Pie chart: inâ€‘frame vs outâ€‘ofâ€‘frame, etc.
â”‚   â”œâ”€â”€ plot_exploratory.py     # Volcano & distribution plots
â”‚   â””â”€â”€ run_ir_pipeline.py      # ğŸƒ Oneâ€‘command orchestration
â”œâ”€â”€ backups/                    # Legacy scripts & notebooks
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ raw/                    # <â€‘ place IRFinder workbook here
â”‚   â”œâ”€â”€ pickles/                # autoâ€‘generated by pickler.py
â”‚   â””â”€â”€ results/                # final TSVs & figures
â”œâ”€â”€ requirements.txt            # PythonÂ 3.10+ deps
â””â”€â”€ .devcontainer/              # VSÂ Code container for reproducibility
```

---

## Quickâ€‘start

```bash
# 1. Clone repository
$ git clone https://github.com/<yourâ€‘org>/intronâ€‘retentionâ€‘analysis.git
$ cd intronâ€‘retentionâ€‘analysis

# 2. Install environment (venv, conda, or use the supplied devâ€‘container)
$ pip install -r requirements.txt

# 3. Add IRFinder Excel workbook
$ mkdir -p data/raw && mv IR_U2OS_TNF.xlsx data/raw/

# 4. Convert sheets to pickles (speeds up downstream reloads)
$ python src/pickler.py data/raw/IR_U2OS_TNF.xlsx
  # â†’ data/pickles/df_CTRL.pkl, df_1HR.pkl, ...

# 5. Run the full pipeline
$ python src/run_ir_pipeline.py \
      --pickles_dir data/pickles \
      --normalized_counts data/raw/DESeq2_normalCounts.xlsx \
      --out_dir data/results

# 6. Browse results
$ tree data/results
  intron_stats.tsv
  coding_impact.tsv
  plots/
      QC_ctrl.png
      deltaIR_volcano.png
      ...
```


## Core workflow

1. **pickler.py** â€“ Reads each sheet (`CTRL`, `1HR`, `2HR`, `4HR`) from the Excel workbook â†’ saves as compressed pickle (â‰ˆ50Ã— faster than reâ€‘parsing `.xlsx`).
2. **process\_ir\_data.py**

   * Filters lowâ€‘quality introns (spliceâ€‘allele warnings, low coverage).
   * Merges replicates and computes Î”IR between timeâ€‘points.
3. **ensembl\_lookup.py** â€“ Queries Ensembl REST + BioMart to grab full transcript sequences and exon boundaries for every unique EnsemblÂ ID.
4. **process\_sequences.py**

   * Reconstructs the *retainedâ€‘intron* transcript for each event.
   * Translates it in all three frames, flags inâ€‘frame introns, and marks premature stop codons (`*`).
5. **analyze\_coding\_impact.py** â€“ Calculates distance to downstream exonâ€‘junctions, predicts NMD vs. productive translation, and tags potential dominantâ€‘negative truncations.
6. **plot\_\*.py** â€“ Generates QC barplots, intronâ€‘type pie charts, Î”IR volcano plots, and chromosome heatmaps.
7. **run\_ir\_pipeline.py** â€“ A thin wrapper that chains everything, logs progress via `tqdm`, and writes tidy CSV + PNG outputs to `data/results`.

---

## Requirements

* PythonÂ 3.10+
* pandas Â· numpy Â· matplotlib Â· seaborn
* biopython Â· pybiomart Â· requests Â· tqdm

A VSÂ Code **devâ€‘container** is included for oneâ€‘click reproducibility (UbuntuÂ 22.04 + PythonÂ 3.12).

---

## Acknowledgements

* Workflow developed in the **RobinÂ Lee Lab** (Dept. of Computational & Systems Biology, University of Pittsburgh).
* Intron quantification via [**IRFinder**](https://github.com/williamritchie/IRFinder) (not bundled here).
* Sequence data from **Ensembl REST API** and **BioMart**.

---

## License

Released under the **MIT License** â€“ see `LICENSE` (or add one!). Contributions are welcome.
